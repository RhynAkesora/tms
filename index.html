<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>魂テトリス</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<link rel="apple-touch-icon" href="icon-192x192.png">
<style>
html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;position:fixed}body{background-color:#f0f0f0;font-family:Arial,sans-serif}#gameContainer{position:absolute;width:100%;height:100%;display:flex;flex-direction:column;justify-content:flex-start;align-items:center}canvas{border:1px solid #000;max-width:100%;max-height:calc(100% - 30px)}#scoreDisplay{width:100%;height:30px;font-size:14px;color:#fff;text-shadow:1px 1px 2px #000;line-height:30px;background-color:rgba(0,0,0,0.5);text-align:center;position:absolute;top:0;left:0;z-index:10}#comboDisplay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:24px;color:#fff;text-shadow:2px 2px 4px #000;display:none;z-index:20}
</style>
</head>
<body>
<div id="gameContainer">
<div id="scoreDisplay">スコア: 0 最高コンボ: 0 速度: 1.00x</div>
<canvas id="gameCanvas"></canvas>
<div id="comboDisplay"></div>
</div>
<script>
const canvas=document.getElementById('gameCanvas'),ctx=canvas.getContext('2d'),scoreDisplayElement=document.getElementById('scoreDisplay'),comboDisplayElement=document.getElementById('comboDisplay'),gridWidth=10,gridHeight=20,cellDivisions=5,colors=['#FF0000','#0000FF','#00FF00','#FFFF00'],pieces=[[[1,1,1,1]],[[1,1],[1,1]],[[1,1,1],[0,1,0]],[[1,1,1],[1,0,0]],[[1,1,1],[0,0,1]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]]],NEXT_PIECE_PADDING=10,NEXT_PIECE_LABEL='NEXT',SPEED_INCREASE_RATE=.99,SPEED_INCREASE_INTERVAL=5,comboTimeThreshold=1e3;let cellSize,sandSize,sandParticles=[],currentPiece,nextPiece,score=0,gameLoop,frameCount=0,isSettling=!1,isClearing=!1,comboCount=0,maxCombo=0,gameState='start',comboDisplayTimeout,touchStartX=0,touchStartY=0,touchStartTime=0,isTouchHolding=!1,lastClearedTime=0,fallSpeed=30,totalRows=0,lastFrameTime=0;const targetFPS=30,offscreenCanvas=document.createElement('canvas'),offscreenCtx=offscreenCanvas.getContext('2d');function resizeCanvas(){const e=window.innerWidth,t=window.innerHeight-30,n=Math.ceil(.4*gridWidth),i=(gridWidth+n)/gridHeight;let a,o;e/t>i?(o=t,a=o*i):(a=e,o=a/i),cellSize=Math.floor(Math.min(a/(gridWidth+n),o/gridHeight)),sandSize=cellSize/cellDivisions,canvas.width=cellSize*(gridWidth+n),canvas.height=cellSize*gridHeight,canvas.style.width=`${canvas.width}px`,canvas.style.height=`${canvas.height}px`,canvas.style.position='absolute',canvas.style.left=`${(e-canvas.width)/2}px`,canvas.style.top=`${(t-canvas.height)/2+30}px`,offscreenCanvas.width=canvas.width,offscreenCanvas.height=canvas.height}function createPiece(){const e=Math.floor(Math.random()*pieces.length),t=Math.floor(Math.random()*colors.length);return{shape:pieces[e],color:t,x:Math.floor(gridWidth/2)-Math.floor(pieces[e][0].length/2),y:0}}function drawGrid(){offscreenCtx.clearRect(0,0,offscreenCanvas.width,offscreenCanvas.height),offscreenCtx.fillStyle='rgba(0, 0, 0, 0.1)',offscreenCtx.fillRect(0,0,cellSize*gridWidth,offscreenCanvas.height),offscreenCtx.beginPath();for(const e of sandParticles)offscreenCtx.rect(e.x*sandSize,e.y*sandSize,sandSize,sandSize),offscreenCtx.fillStyle=colors[e.color],offscreenCtx.fill();ctx.clearRect(0,0,canvas.width,canvas.height),ctx.drawImage(offscreenCanvas,0,0)}function drawPiece(){if(!currentPiece)return;ctx.fillStyle=colors[currentPiece.color];for(let e=0;e<currentPiece.shape.length;e++)for(let t=0;t<currentPiece.shape[e].length;t++)currentPiece.shape[e][t]&&ctx.fillRect((currentPiece.x+t)*cellSize,(currentPiece.y+e)*cellSize,cellSize-1,cellSize-1)}function drawNextPiece(){const e=canvas.width-cellSize*gridWidth,t=Math.min(.8*cellSize,(e-2*NEXT_PIECE_PADDING)/4),n=cellSize*gridWidth+(e-4*t)/2,i=2*NEXT_PIECE_PADDING+20;ctx.fillStyle='rgba(0, 0, 0, 0.2)',ctx.fillRect(cellSize*gridWidth,0,e,canvas.height),ctx.strokeStyle='white',ctx.lineWidth=2,ctx.beginPath(),ctx.moveTo(cellSize*gridWidth,0),ctx.lineTo(cellSize*gridWidth,canvas.height),ctx.stroke(),ctx.fillStyle='white',ctx.font='20px Arial',ctx.textAlign='center',ctx.fillText(NEXT_PIECE_LABEL,cellSize*gridWidth+e/2,NEXT_PIECE_PADDING+20),ctx.fillStyle='rgba(255, 255, 255, 0.1)',ctx.fillRect(n,i,4*t,4*t),ctx.fillStyle=colors[nextPiece.color];for(let e=0;e<nextPiece.shape.length;e++)for(let a=0;a<nextPiece.shape[e].length;a++)nextPiece.shape[e][a]&&ctx.fillRect(n+(a+(4-nextPiece.shape[e].length)/2)*t,i+(e+(4-nextPiece.shape.length)/2)*t,t-1,t-1)}function canMove(e,t){if(!currentPiece)return!1;for(let n=0;n<currentPiece.shape.length;n++)for(let i=0;i<currentPiece.shape[n].length;i++)if(currentPiece.shape[n][i]){const a=currentPiece.x+i+e,o=currentPiece.y+n+t;if(a<0||a>=gridWidth||o>=gridHeight||sandParticles.some(e=>Math.floor(e.x/cellDivisions)===a&&Math.floor(e.y/cellDivisions)===o))return!1}return!0}function rotate(){if(!currentPiece)return;const e=currentPiece.shape[0].map((e,t)=>currentPiece.shape.map(e=>e[t]).reverse()),t=currentPiece.shape;currentPiece.shape=e,canMove(0,0)||(currentPiece.shape=t)}function mergePiece(){if(!currentPiece)return;for(let e=0;e<currentPiece.shape.length;e++)for(let t=0;t<currentPiece.shape[e].length;t++)if(currentPiece.shape[e][t])for(let n=0;n<cellDivisions;n++)for(let i=0;i<cellDivisions;i++)sandParticles.push({x:(currentPiece.x+t)*cellDivisions+n,y:(currentPiece.y+e)*cellDivisions+i,color:currentPiece.color});currentPiece=null,isSettling=!0}function findConnectedComponents(e){const t=new Set,n=[];for(const i of sandParticles)i.color===e&&!t.has(`${i.x},${i.y}`)&&(component=new Set,dfs(i,e,t,component),n.push(component));return n}function dfs(e,t,n,i){const a=`${e.x},${e.y}`;if(!n.has(a)){n.add(a),i.add(a);for(const[a,o]of[[0,1],[1,0],[0,-1],[-1,0]]){const r=e.x+a,s=e.y+o,c=sandParticles.find(e=>e.x===r&&e.y===s&&e.color===t);c&&dfs(c,t,n,i)}}}function isFullWidth(e){let t=gridWidth*cellDivisions,n=0;for(const i of e){const[e]=i.split(',').map(Number);t=Math.min(t,e),n=Math.max(n,e)}return n-t+1===gridWidth*cellDivisions}function removeSandParticles(e){sandParticles=sandParticles.filter(t=>!e.has(`${t.x},${t.y}`))}function calculateComboScore(e,t){return Math.floor(100*t*Math.pow(1.5,e-1))}function showComboDisplay(e){if(e<2)return;const t=Math.pow(1.5,e-1).toFixed(2);comboDisplayElement.textContent=`${e} コンボ! (x${t})`,comboDisplayElement.style.display='block',clearTimeout(comboDisplayTimeout),comboDisplayTimeout=setTimeout(()=>{comboDisplayElement.style.display='none'},2e3)}function checkAndClearLines(){let e=!1,t=0;for(let n=0;n<colors.length;n++){const i=findConnectedComponents(n);for(const n of i)isFullWidth(n)&&(removeSandParticles(n),e=!0,t++)}const n=Date.now();if(e){n-lastClearedTime<comboTimeThreshold?comboCount++:comboCount=1,lastClearedTime=n;const e=calculateComboScore(comboCount,t);score+=e,showComboDisplay(comboCount),maxCombo=Math.max(maxCombo,comboCount)}return e}function simulateSand(){let e=!1;return sandParticles.sort((e,t)=>t.y-e.y),sandParticles.forEach(t=>{if(Math.random()<.5)return;if(t.y<gridHeight*cellDivisions-1&&!sandParticles.some(e=>e.x===t.x&&e.y===t.y+1))t.y++,e=!0;else if(t.y<gridHeight*cellDivisions-1){const n=t.x>0&&!sandParticles.some(e=>e.x===t.x-1&&e.y===t.y+1),i=t.x<gridWidth*cellDivisions-1&&!sandParticles.some(e=>e.x===t.x+1&&e.y===t.y+1);n&&i?(t.x+=Math.random()<.5?-1:1,t.y++,e=!0):n?(t.x--,t.y++,e=!0):i&&(t.x++,t.y++,e=!0)}}),e}function updateScoreDisplay(){scoreDisplayElement.textContent=`スコア: ${score} 最高コンボ: ${maxCombo}x 速度: ${(30/fallSpeed).toFixed(2)}x`}function gameOver(){gameState='gameOver',cancelAnimationFrame(gameLoop),drawGameOverScreen()}function drawStartScreen(){ctx.fillStyle='rgba(0, 0, 0, 0.5)',ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle='white',ctx.font='30px Arial',ctx.textAlign='center',ctx.fillText('魂テトリス',canvas.width/2,canvas.height/2-40),ctx.font='20px Arial',ctx.fillText('タップして開始',canvas.width/2,canvas.height/2+20)}function drawGameOverScreen(){ctx.fillStyle='rgba(0, 0, 0, 0.5)',ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle='white',ctx.font='30px Arial',ctx.textAlign='center',ctx.fillText('ゲームオーバー',canvas.width/2,canvas.height/2-40),ctx.font='20px Arial',ctx.fillText(`最終スコア: ${score}`,canvas.width/2,canvas.height/2),ctx.fillText('タップしてリトライ',canvas.width/2,canvas.height/2+40)}function resetGame(){sandParticles=[],score=0,comboCount=0,maxCombo=0,isSettling=!1,isClearing=!1,frameCount=0,lastClearedTime=0,currentPiece=createPiece(),nextPiece=createPiece(),fallSpeed=30,totalRows=0,updateScoreDisplay(),gameState='playing',update()}function update(e){if(e-lastFrameTime<1e3/targetFPS)return void(gameLoop=requestAnimationFrame(update));if(lastFrameTime=e,'playing'!==gameState)return;if(frameCount++,frameCount%Math.floor(fallSpeed)==0&&!isSettling&&!isClearing&&currentPiece)if(canMove(0,1))currentPiece.y++,score++,totalRows++,totalRows%SPEED_INCREASE_INTERVAL==0&&(fallSpeed*=SPEED_INCREASE_RATE);else if(mergePiece(),isSettling=!0,isSettling){if(!simulateSand())if(isSettling=!1,isClearing=!0,isClearing){if(!checkAndClearLines())if(isClearing=!1,!currentPiece&&(currentPiece=nextPiece,nextPiece=createPiece(),!canMove(0,0)))return void gameOver()}else isSettling=!0}drawGrid(),currentPiece&&!isSettling&&!isClearing&&drawPiece(),drawNextPiece(),updateScoreDisplay(),gameLoop=requestAnimationFrame(update)}function handleTouch(e){if('playing'!==gameState)return;switch(e){case'left':canMove(-1,0)&&currentPiece.x--;break;case'right':canMove(1,0)&&currentPiece.x++;break;case'rotate':rotate();break;case'drop':for(;canMove(0,1);)currentPiece.y++,score++,totalRows++;mergePiece()}}function handleCanvasClick(e){e.preventDefault(),('start'===gameState||'gameOver'===gameState)&&resetGame()}function initEventListeners(){canvas.addEventListener('touchstart',e=>{e.preventDefault();const t=e.touches[0];touchStartX=t.clientX,touchStartY=t.clientY,touchStartTime=Date.now(),isTouchHolding=!0}),canvas.addEventListener('touchmove',e=>{if(e.preventDefault(),'playing'!==gameState)return;const t=e.touches[0],n=t.clientX-touchStartX,i=t.clientY-touchStartY;Math.abs(n)>cellSize&&(handleTouch(n>0?'right':'left'),touchStartX=t.clientX),i>cellSize&&isTouchHolding&&(handleTouch('drop'),isTouchHolding=!1)}),canvas.addEventListener('touchend',e=>{e.preventDefault();Date.now()-touchStartTime<200&&isTouchHolding&&handleTouch('rotate'),isTouchHolding=!1}),canvas.addEventListener('click',handleCanvasClick),canvas.addEventListener('touchend',handleCanvasClick),window.addEventListener('resize',()=>{resizeCanvas(),'start'===gameState?drawStartScreen():'gameOver'===gameState&&drawGameOverScreen()}),document.addEventListener('keydown',e=>{if('playing'===gameState)switch(e.code){case'ArrowLeft':handleTouch('left');break;case'ArrowRight':handleTouch('right');break;case'ArrowUp':handleTouch('rotate');break;case'ArrowDown':handleTouch('drop')}else'Space'===e.code&&('start'===gameState||'gameOver'===gameState)&&resetGame()})}function init(){resizeCanvas(),initEventListeners(),drawStartScreen()}init();
</script>
<script>
'serviceWorker'in navigator&&window.addEventListener('load',()=>{navigator.serviceWorker.register('sw.js').then(e=>{console.log('Service Worker registered:',e)}).catch(e=>{console.log('Service Worker registration failed:',e)})});
</script>
</body>
</html>
